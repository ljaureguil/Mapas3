<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<head>
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="https://cdn.pixabay.com/photo/2023/11/01/12/18/mail-8357450_1280.jpg">
    <title>Mapas3</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>




<style>
#map {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 80%;
}
.leaflet-popup-content {
  font-size: 14px;
}
#filters {
  display: flex; 
  flex-direction: column; 
  gap: 0.75rem;
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
button {
  /* background-color: #0172ad; */
  background-color: transparent;
  /* border: 0.0625rem solid #0172ad; */
  border: 0.0625rem solid transparent;
  border-radius: 0.25rem;
  box-shadow: 0 0 0 transparent;
  /* color: #fff; */
  /* color: #559dd4; */
  color: #000;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 400;
  line-height: 1.5;
  outline: 0;
  padding: 0.25rem;
  text-align: center;
  text-decoration: none;
  transition: all 0.2 ease-in-out;
  user-select: none;
}
#filters button.disabled {
  opacity: 0.25;
}
#filters svg {
  width: 1rem;
}
footer {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  margin: 1rem;
  z-index: 100;
  text-align: center;
}
#additem {
  background-color: #0172ad;
  border: 0.0625rem solid #0172ad;
  border-radius: 100em;
  color: #fff;
  padding: .75rem;
}
#additem svg {
  width: 3rem;
} 


</style>
</style>

<!-- Filter Buttons -->


<div id="filters">
  <button data-type="water" onclick="toggleMarkers('water')">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M214.683 26.824c-6.072-.12-12.087 1.004-17.863 3.766c-9.62 4.6-13.792 15.067-13.713 24.023c.079 8.957 2.688 17.853 5.183 26.637c2.496 8.784 4.953 17.403 5.592 24.139c.64 6.736-.278 10.517-2.84 13.084c-4.94 4.95-10.999 6.526-19.837 6.228c-8.84-.297-19.734-2.91-31.102-5.771s-23.212-5.963-34.973-6.508s-24.137 1.818-33.644 10.648c-21 19.507-29.23 45.076-30.444 72.797c-1.045 23.894 2.817 49.884 7.666 77.24a320 320 0 0 0 17.659-3.601c-4.712-26.817-8.271-51.61-7.342-72.852c1.085-24.808 7.621-44.52 24.71-60.394c5.135-4.77 11.525-6.274 20.561-5.856c9.036.42 20.021 3.114 31.414 5.98c11.393 2.868 23.194 5.914 34.89 6.307c11.694.394 24.008-2.309 33.183-11.503c7.584-7.601 8.91-18.12 8.02-27.502c-.892-9.382-3.74-18.699-6.198-27.354s-4.453-16.702-4.498-21.877c-.046-5.175.138-6.029 3.476-7.625c8.217-3.928 18.665-2.12 31.375 4.9c12.712 7.021 26.54 18.95 38.975 31.735c19.341 19.885 35.042 41.174 41.21 49.851a3085 3085 0 0 0 14.355-10.89c-6.876-9.633-22.991-31.29-42.66-51.512c-13.144-13.512-27.848-26.472-43.178-34.94c-9.582-5.292-19.857-8.95-29.977-9.15m223.649 30.834c-3.928-.095-7.467.275-10.315.994c-5.696 1.44-7.486 3.62-7.809 4.729c-.322 1.11.038 3.847 4.153 7.848s11.36 8.146 20.152 10.441s17.255 2.25 22.951.81s7.484-3.615 7.807-4.724c.322-1.11-.036-3.85-4.15-7.85s-11.359-8.148-20.15-10.443c-4.397-1.148-8.712-1.709-12.64-1.805zm-27.67 27.957c-7.085 5.414-14.14 10.79-21.405 16.436c13.589 18.425 32.911 30.366 60.432 33.185c2.615-10.891 5.15-21.564 7.685-32.193c-5.91-.04-12.087-.872-18.347-2.506c-11.47-2.994-21.263-8.159-28.365-14.922m-36.834 28.393c-97.063 75.548-206.209 159.733-325.34 179.11c-13.564 2.205-19.404 8.658-22.9 20.308c-3.497 11.65-2.833 28.71 1.585 47.053c8.556 35.518 31.115 75.613 51.887 94.316c18.395-2.027 41.96-6.153 65.463-12.729c-3.165-4.838-6.055-10.11-8.762-15.77l17.72-8.474c3.5 7.317 6.79 13.298 10.354 18.2c2.421-.838 4.86-1.648 7.24-2.543c9.494-3.57 18.525-7.633 26.823-12.11c-6.486-5.76-12.254-12.132-16.84-18.994l16.332-10.914c4.53 6.78 10.874 13.25 18.178 18.838c11.693-8.596 20.57-18.284 25.068-28.836l18.07 7.703c-5.312 12.463-13.994 23.013-24.769 32.065c6.074 2.707 12.336 4.748 18.557 5.687l-2.934 19.424c-11.97-1.807-23.45-6.183-33.898-12.188c-10.696 6.393-22.483 11.797-34.604 16.498c2.793 1.315 5.853 2.418 9.258 3.35l-5.188 18.945c-10.658-2.918-19.375-7.844-26.752-14.447c-18.489 5.66-37.113 9.768-53.935 12.578c20.436 9.494 44.948 14.174 70.25 14.106c35.905-.098 72.954-9.544 100.234-25.434c101.172-58.93 140.87-186.58 170.084-305.31c-30.923-4.017-54.847-18.973-71.181-40.432m80.052 228.416s-47.855 67.63-37.367 102.426c4.397 14.585 21.55 27.507 36.78 27.125c14.57-.366 29.75-13.698 33.845-27.686c10.036-34.28-33.258-101.865-33.258-101.865"></path></svg>
  </button>
  <button data-type="shelter" onclick="toggleMarkers('shelter')">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28"><path fill="currentColor" d="M14.601 3.211a.75.75 0 0 0-1.152 0c-1.795 2.154-5.337 4.71-7.374 5.848a.75.75 0 0 0-.377.552L4.06 21.5H2.75a.75.75 0 0 0 0 1.5h22.5a.75.75 0 0 0 0-1.5h-1.26L22.352 9.61a.75.75 0 0 0-.378-.552c-2.036-1.138-5.578-3.694-7.373-5.848M10.272 21.5c1.259-1.83 2.557-4.18 3.728-7.892c1.059 3.35 2.24 5.665 3.728 7.892z"></path></svg>  
  </button>
</div>

<!-- Map Container -->
<div id="map"></div>

<!-- Add Item --> 
<footer>
  <button id="additem" onclick="addMark()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M5 13v-1h6V6h1v6h6v1h-6v6h-1v-6z"></path></svg>
  </button>
</footer>
<button onclick="addMark()" style="z-index:101;width: 10%;height: 5%;background-color: rgb(219, 30, 30);position:absolute;bottom: 3%;">Mark</button>
<select id="sopc" oninput="selectOpc(this.value)" style="z-index:101;width: 10%;height: 5%;background-color: rgb(219, 30, 30);position:absolute;bottom: 3%;right:1%;">
  <option value="option1">Choose an Option</option>
  <option value="option2">make polygon</option>
  <option value="option3">calc dist</option>
</select>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var linklib="https://raw.githubusercontent.com/ljaureguil/My-Library/refs/heads/master/MyLibmin.js";
var link="https://api.jsonblob.com/019b5163-39dc-74c4-b292-6655ebb3cf98"


loadDoc = function(url,callback) {

        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", url, false);
        xhttp.send();
       if(callback!=undefined) callback(xhttp.responseText);
        return xhttp.responseText;
    }





loadDoc(linklib,function(data){
  eval(data);

  GetJson(link,function(r){
    alert(JSON.stringify(r) );
  });
})


  








  let map,coord={},routes=[],route={points:[]},lastPoint=null,polarea=0,polpoints=[];
  let markers = { water: [], shelter: [] },marker;
  let markerState = { water: true, shelter: true }; // Track enabled/disabled states
  
  // Example Locations
  const locations = [
    { type: 'water', name: 'River Access Point', coords: [42.2800, -89.1000] },
    { type: 'shelter', name: 'Camping Spot', coords: [42.2650, -89.0800] },
    { type: 'water', name: 'Water Well', coords: [42.2900, -89.1200] },
    { type: 'water', name: 'Lake Shore', coords: [42.2750, -89.1100] },
    { type: 'shelter', name: 'Forest Cabin', coords: [32.2600, -89.1300] },
    { type: 'shelter', name: 'Cabin Shelter', coords: [42.2750, -89.0900] }
  ];
  
  function initMap() {
    map = L.map('map').setView([42.2711, -89.0937], 12);
  
    //////////////////////////

setTimeout(function(){
				map.on('click', 
					function(e){
						var coord = e.latlng.toString().split(',');//alert(e.latlng.toString())

						var lat = coord[0].split('(');
						var lng = coord[1].split(')');
			//			alert("You clicked the map at latitude: " + lat[1] + "\n\n and longitude:" + lng[0]);
   var lat = (e.latlng.lat);
    var lng = (e.latlng.lng);
    var newLatLng = new L.LatLng(lat, lng);
    marker.setLatLng(newLatLng); 
      marker.bindPopup("<b>"+coord+"</b><br>is here").openPopup();
      lastPoint={lat:lat,lng:lng};
           
					});
},1000);



    //////////////////////////////////
    // OpenStreetMap Tile Layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    // Add Markers to Map
    locations.forEach(loc => {
      const marker = L.marker(loc.coords)
        .bindPopup(`<b>${loc.name}</b><br>Type: ${loc.type}`);
  
      markers[loc.type].push(marker);
      marker.addTo(map);
    });
  
    updateButtons(); // Set initial button states
  }
  
  // Toggle Marker Visibility & Update Button States
  function toggleMarkers(type) {
    if (!markers[type]) return;
  
    markerState[type] = !markerState[type]; // Toggle state
  
    markers[type].forEach(marker => {
      if (markerState[type]) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  
    updateButtons(); // Update button states
  }
  
  // Update Button Disabled States
  function updateButtons() {
    Object.keys(markerState).forEach(type => {
      const button = document.querySelector(`button[data-type="${type}"]`);
      if (button) {
        button.classList.toggle("disabled", !markerState[type]);
 // Disable when markers are hidden
      }
    });
  }
  
  
  
  document.addEventListener("DOMContentLoaded", initMap);
  
  
  
  
  const options = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0,
};

function success(pos) {
  const crd = pos.coords;

 // alert("Your current position is:  "+`Latitude : ${crd.latitude}`+`Longitude: ${crd.longitude}`+`More or less ${crd.accuracy} meters.`);
  map.setView([crd.latitude, crd.longitude], 13);

 marker = L.marker([crd.latitude, crd.longitude]).addTo(map);
    marker.bindPopup("<b>AQUI</b><br>is here").openPopup();

  //  alert(JSON.stringify(marker));
 //   alert(marker.latitude)

}

function error(err) {
  alert(`ERROR(${err.code}): ${err.message}`);
}

  
  
  window.navigator.geolocation.getCurrentPosition(success, error, options);
  
  addMark = function(){
 window.navigator.geolocation.getCurrentPosition(function(pos){ 
 var cord= pos.coords;
//getGCords(function(cord){
  var cos=JSON.stringify(cord).replace(/"/g," ").replace(/,/g,"<br>").replace(/{/g,"<br>").replace(/}/g,"<br>");
 // alert(cos)
  map.setView([cord.latitude, cord.longitude], 13);

var marker = L.marker([cord.latitude, cord.longitude]).addTo(map);
 // marker.coords=cos;//marker.coord
    marker.bindPopup("<b>"+cos+"</b>").openPopup()
  //   marker.bindPopup("<b>oooo</b><br>is here").openPopup();
 })
 
    } 
  

  function getGCords(callback){
window.navigator.geolocation.getCurrentPosition(function(cord){callback(cord)}, error, options);

  }


function selectOpc(val){
  if(val==="option2"){
    route={points:[]};
    routes=[];
    map.on('click', 
          function(e){
            var lat = (e.latlng.lat);
            var lng = (e.latlng.lng);
            route.points.push([lat,lng]);
          //  alert("Point added to polygon: " + lat + ", " + lng);
            marker = L.marker([lat,lng]).addTo(map);
            var so=route.points.length;

            marker.bindPopup("<b>Point: "+so+"  "+"</b>").openPopup()
            if(route.points.length>=3){
              if(routes.length>0){
                map.removeLayer(routes[routes.length-1]);

              }
              var polygon = L.polygon(route.points, {color: 'blue'}).addTo(map);
              routes.push(polygon);
            }
          })
  }
  if(val==="option3"){
    route={points:[]};
    routes=[];
    map.on('click', 
          function(e){
            var lat = (e.latlng.lat);
            var lng = (e.latlng.lng);
            route.points.push([lat,lng]);
        //    alert("Point added to distance calc: " + lat + ", " + lng);
var myIcon = L.icon({
    iconUrl: 'https://www.pngguru.in/storage/uploads/images/a-colorful-bird-free-png-images-on-transparent-background_1744195175_1266534286.webp',
    iconSize: [38, 95],
    iconAnchor: [22, 94],
    popupAnchor: [-3, -76],
   // shadowUrl: 'my-icon-shadow.png',
    shadowSize: [68, 95],
    shadowAnchor: [22, 94]
});
/*var myIcon = L.divIcon({
    className: 'my-div-icon',
    html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;">punto uno</div>',
    iconSize: [24, 24],
    iconAnchor: [12, 12]
});*/
var myIcon = L.divIcon({className: 'my-div-icon'});
//alert(JSON.stringify(myIcon));
//L.marker([lat,lng], {icon: myIcon}).addTo(map);
marker = L.marker([lat,lng]).addTo(map);

          //   marker = L.marker([lat,lng]).addTo(map);
            if(route.points.length===2){
              var from=L.latLng(route.points[0][0],route.points[0][1]);
              var to=L.latLng(route.points[1][0],route.points[1][1]);
              var dist=from.distanceTo(to);
              var obdis={};
              obdis.distance=dist.toFixed(2);
              obdis.from=from;
              obdis.to=to;
              var so=JSON.stringify(obdis).replace(/"/g," ").replace(/,/g,"<br>").replace(/{/g,"<br>").replace(/}/g,"<br>");
          //    alert(JSON.stringify(obdis));
           //
              myLine = L.polyline([route.points[0], route.points[1]], {color: 'green'}).addTo(map);
           //   alert("Distance between points: "+dist.toFixed(2)+" meters.");
//L.marker([lat,lng], {icon: myIcon}).addTo(map);
marker = L.marker([lat,lng]).addTo(map);
 marker.bindPopup("<b>Distance to previous point: "+so+" meters."+"</b>").openPopup()
//marker = L.marker([lat,lng], {icon: myIcon}).addTo(map);
         //     marker = L.marker([lat,lng]).addTo(map);
              route={points:[]};
              if(routes.length>0){
                map.removeLayer(routes[routes.length-1]);
              }
            }
          })
  }
}


function calculatePolygonArea(coords) {
  let area = 0;
  for (let i = 0; i < coords.length; i++) {
    const [x1, y1] = coords[i];
    const [x2, y2] = coords[(i + 1) % coords.length];
    area += x1 * y2 - x2 * y1;
  }
  return Math.abs(area / 2); // Use Math.abs for a positive area value
}





</script>
